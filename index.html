<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ•å¼€å€’é…’å¤§æ¯”æ‹¼ | Offenbar Challenge</title>
    <style>
        :root {
            --bg-color: #111;
            --text-color: #fff;
            --accent-color: #f39c12; /* å•¤é…’é»„ */
            --glass-border: rgba(255, 255, 255, 0.6);
            --success-color: #2ecc71;
            --fail-color: #e74c3c;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            /* ç¦æ­¢ç§»åŠ¨ç«¯é»˜è®¤è§¦æ‘¸è¡Œä¸ºï¼ˆå¦‚åŒå‡»ç¼©æ”¾ã€æ»šåŠ¨ï¼‰ */
            touch-action: none; 
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* ä½¿ç”¨ dvh é€‚é…ç§»åŠ¨ç«¯åŠ¨æ€åœ°å€æ  */
            height: 100vh;
            height: 100dvh; 
            overflow: hidden;
        }

        /* --- UI å®¹å™¨ --- */
        .container {
            width: 100%;
            max-width: 480px; /* é™åˆ¶å¹³æ¿/æ¡Œé¢ç«¯æœ€å¤§å®½åº¦ */
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            padding: 20px;
        }

        /* --- Logo åŒºåŸŸ --- */
        .header {
            text-align: center;
            margin-top: 5vh; /* å¾€ä¸‹æŒª */
            margin-bottom: 1vh; /* å¼¹æ€§é—´è· */
            flex-shrink: 0;
            position: relative;
            z-index: 50;
        }

        .logo-img {
            width: 100px; /* ç¼©å°logo */
            height: auto;
            display: block;
            margin: 0 auto 5px;
            filter: drop-shadow(0 0 5px rgba(255,255,255,0.2));
        }

        .game-title {
            font-size: 2rem;
            font-weight: bold;
            letter-spacing: 3px;
            color: var(--accent-color);
            text-shadow: 0 0 20px rgba(243, 156, 18, 0.5);
        }

        /* ç»“æœé¡µçš„headeræ ·å¼è°ƒæ•´ */
        .container.result-page .header .game-title {
            display: none;
        }

        .container.result-page .header .logo-img {
            width: 60px;
        }

        .container.result-page .header {
            margin-top: 2vh;
            margin-bottom: 0.5vh;
        }

        /* --- å±å¹•ç®¡ç† --- */
        .screen {
            flex-grow: 1;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* é»˜è®¤å‚ç›´å±…ä¸­ */
            width: 100%;
            transition: opacity 0.3s ease;
            position: relative;
        }
        
        .screen#screen-game {
            justify-content: flex-end; /* æ¸¸æˆç•Œé¢åº•éƒ¨å¯¹é½ */
            padding-bottom: 20px;
        }

        .screen#screen-result {
            justify-content: flex-start; /* ç»“æœé¡µä»é¡¶éƒ¨å¼€å§‹ */
            overflow-y: auto; /* æ”¯æŒæ»šåŠ¨ */
            -webkit-overflow-scrolling: touch;
            padding-top: 10px;
            padding-bottom: 20px; /* å¢åŠ åº•éƒ¨paddingï¼Œç¡®ä¿æŒ‰é’®å¯è§ */
            align-items: center; /* ç¡®ä¿å­å…ƒç´ å±…ä¸­ */
            min-height: 0; /* å…è®¸flexå­å…ƒç´ ç¼©å°ï¼Œå¯ç”¨æ»šåŠ¨ */
            max-height: 100%; /* é™åˆ¶æœ€å¤§é«˜åº¦ï¼Œç¡®ä¿å¯ä»¥æ»šåŠ¨ */
        }

        .screen.active {
            display: flex;
        }

        /* --- å¼€å§‹/ç»“ç®—é€šç”¨å…ƒç´  --- */
        input[type="text"] {
            background: transparent;
            border: none;
            border-bottom: 2px solid #fff;
            color: #fff;
            font-size: 1.5rem;
            text-align: center;
            padding: 10px;
            margin-bottom: 30px;
            width: 80%;
            outline: none;
            border-radius: 0; /* iOS fix */
        }

        .btn {
            background: #fff;
            color: #000;
            border: none;
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            border-radius: 50px;
            text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(255,255,255,0.2);
            margin: 10px 0;
        }

        .btn:active {
            transform: scale(0.95);
            background: #ddd;
        }

        /* --- æ¸¸æˆä¸»ç•Œé¢å¸ƒå±€ --- */
        .game-info {
            position: absolute;
            top: 10px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #888;
            z-index: 50;
            pointer-events: none; /* é˜²æ­¢é®æŒ¡ç‚¹å‡» */
        }

        /* --- è§†è§‰åŒºåŸŸï¼šé…’ç“¶ä¸æ°´æµ (æ ¸å¿ƒä¿®æ”¹) --- */
        .visual-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 60%; /* å æ®ä¸ŠåŠéƒ¨åˆ† */
            pointer-events: none;
        }

        /* å¯¹é½æ ¸å¿ƒé€»è¾‘ï¼š
           1. .pour-point æ˜¯å±å¹•ç»å¯¹ä¸­å¿ƒçš„ä¸€ä¸ªç‚¹ï¼Œä½œä¸ºå€’é…’çš„æºå¤´ã€‚
           2. .stream ä»è¿™ä¸ªç‚¹å‘ä¸‹å»¶ä¼¸ã€‚
           3. .bottle-container å®šä½åœ¨è¿™ä¸ªç‚¹ä¸Šï¼Œæ—‹è½¬ä¸­å¿ƒä¹Ÿæ˜¯è¿™ä¸ªç‚¹ã€‚
        */
        .pour-point {
            position: absolute;
            top: 12vh; /* å€’é…’ç‚¹çš„é«˜åº¦ä½ç½® */
            left: 50%;
            width: 0;
            height: 0;
            /* debug: border: 2px solid red; */
        }

        .stream {
            position: absolute;
            top: 0; /* ä» pour-point å¼€å§‹ */
            left: 50%;
            transform: translateX(-50%); /* ä¸¥æ ¼å±…ä¸­ */
            width: 6px;
            height: 0;
            background: var(--accent-color);
            transition: height 0.1s ease-out;
            z-index: 5;
            opacity: 0.9;
            box-shadow: 0 0 5px var(--accent-color);
        }
        
        .stream.active {
            /* ä»ç“¶å£åˆ°æ¯å­å†…éƒ¨çš„å›ºå®šè·ç¦» */
            /* ç¼©çŸ­é•¿åº¦ï¼Œè®©æ°´æµåœåœ¨æ¯å­å†…éƒ¨ï¼Œä¸è¶…å‡ºåº•éƒ¨ */
            height: calc(53vh - 250px);
        }

        .bottle-container {
            position: absolute;
            top: 0;
            left: 0; /* é”šå®šåœ¨ pour-point */
            width: 0;
            height: 0;
            /* å…³é”®ï¼šæ—‹è½¬ä¸­å¿ƒè®¾ä¸ºè‡ªèº«åŸç‚¹(å³pour-point) */
            transform-origin: 0 0; 
            transform: rotate(0deg);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10;
        }

        .bottle-container.pouring {
            /* æ—‹è½¬å®¹å™¨ï¼Œè®©ç“¶èº«å€’ä¸‹æ¥ */
            transform: rotate(-60deg);
        }

        /* ç“¶èº«ï¼šç›¸å¯¹äºé”šç‚¹åç§»ï¼Œä½¿å…¶çœ‹èµ·æ¥æ˜¯æ‹¿åœ¨æ‰‹é‡Œçš„ */
        .bottle-body {
            position: absolute;
            /* åˆå§‹çŠ¶æ€ï¼šç“¶å˜´å¯¹å‡†åŸç‚¹ï¼Œç“¶èº«å‘å³ä¸Šæ–¹å»¶ä¼¸ */
            top: -15px; 
            left: 10px; 
            width: 70px;
            height: 160px;
            background: #222;
            border-radius: 20px 20px 5px 5px; /* å€’è¿‡æ¥çš„å½¢çŠ¶ */
            border: 2px solid #555;
            box-shadow: inset 5px 0 10px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ç“¶é¢ˆ */
        .bottle-body::before {
            content: '';
            position: absolute;
            top: -20px; /* ç“¶å˜´éƒ¨åˆ† */
            left: 50%;
            transform: translateX(-50%);
            width: 25px;
            height: 25px;
            background: #333;
            border: 2px solid #555;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
        }

        .bottle-label {
            transform: rotate(90deg);
            color: rgba(255,255,255,0.15);
            font-weight: bold;
            font-size: 14px;
            letter-spacing: 2px;
            white-space: nowrap;
        }

        /* --- å›ºå®šé…’æ¯ --- */
        .glass-area {
            position: absolute;
            bottom: 35vh; /* å›ºå®šæ¯å­åº•éƒ¨ä½ç½®ï¼Œç•™å‡ºè¶³å¤Ÿç©ºé—´ç»™æŒ‰é’®åŒºåŸŸ */
            left: 0;
            width: 100%;
            height: 180px; /* å›ºå®šé«˜åº¦ï¼Œæ­£å¥½å®¹çº³æ¯å­ */
            display: flex;
            justify-content: center;
            align-items: flex-end;
            z-index: 20;
        }

        .glass {
            position: relative;
            border: 3px solid var(--glass-border);
            border-top: none;
            overflow: hidden;
            transform: translateZ(0);
            background: rgba(255, 255, 255, 0.05);
            /* ç¡®ä¿æ¯å­åœ¨æ°´æµæ­£ä¸‹æ–¹ */
            margin: 0 auto; 
        }

        /* å›ºå®šæ¯å‹ - åªç”¨ä¸€ç§å¤§æ¯å­ */
        .glass.beer {
            width: 100px;
            height: 180px;
            border-radius: 5px 5px 15px 15px;
        }

        /* æ¶²ä½“ */
        .liquid {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            /* ç§»é™¤è¿‡æ¸¡æ•ˆæœä»¥å®ç°æ›´çµæ•çš„æ§åˆ¶æ„Ÿï¼Œæˆ–è€…ä¿ç•™æçŸ­çš„è¿‡æ¸¡ */
            transition: height 0.05s linear; 
        }

        .glass.beer .liquid { background-color: #f39c12; box-shadow: 0 0 10px #f39c12 inset; }

        .foam {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 0;
            background: rgba(255,255,255,0.8);
            transition: height 0.1s;
        }
        .glass.beer .liquid .foam { height: 8px; }

        /* ç›®æ ‡åˆ»åº¦çº¿ */
        .target-zone {
            position: absolute;
            left: -5px;
            right: -5px;
            border-top: 2px dashed rgba(255,255,255,0.5);
            border-bottom: 2px dashed rgba(255,255,255,0.5);
            pointer-events: none;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* å¢åŠ ä¸€ä¸ªä¸­é—´å®Œç¾çº¿ */
        .target-zone::after {
            content: '';
            width: 100%;
            height: 1px;
            background: rgba(255,255,255,0.2);
        }

        .target-label {
            position: absolute;
            right: -55px;
            color: #fff;
            font-size: 0.7rem;
            text-shadow: 0 0 2px #000;
            opacity: 0.8;
        }

        /* --- æ“ä½œæŒ‰é’®åŒºåŸŸ --- */
        .controls-area {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 28vh; /* å¢åŠ é«˜åº¦ï¼Œé¿å…å’Œæ¯å­é‡å  */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .instruction-text {
            text-align: center; 
            margin-bottom: 15px; 
            font-size: 0.85rem; 
            color: #666;
            letter-spacing: 1px;
        }

        .pour-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: radial-gradient(circle, #fff 30%, #bbb 100%);
            border: 4px solid #333;
            color: #111;
            font-weight: 900;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 15px rgba(255,255,255,0.1);
            cursor: pointer;
            transition: transform 0.1s, background 0.2s, box-shadow 0.2s;
            position: relative;
            z-index: 100; /* æœ€é«˜å±‚çº§ï¼Œç¡®ä¿å¯ç‚¹å‡» */
        }

        .pour-btn:active {
            transform: scale(0.92);
            background: radial-gradient(circle, #ddd 30%, #999 100%);
            box-shadow: 0 0 5px rgba(255,255,255,0.1);
        }

        .pour-btn.disabled {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(100%);
        }

        /* --- ç»“ç®—å¼¹çª—ä¼˜åŒ– --- */
        .score-display {
            font-size: 5rem;
            font-weight: bold;
            margin: 10px 0;
            line-height: 1;
            text-shadow: 0 0 20px rgba(255,255,255,0.2);
        }

        .score-msg {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #aaa;
            height: 1.5em; /* å ä½é˜²æ­¢è·³åŠ¨ */
        }

        /* æ’è¡Œæ¦œç´§å‡‘åŒ– */
        .leaderboard-container {
            width: 100%;
            flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            align-items: center; /* ç¡®ä¿å†…å®¹å±…ä¸­ */
        }

        .leaderboard-box {
            background: rgba(255,255,255,0.08);
            border-radius: 8px;
            padding: 15px;
            width: 100%;
            max-width: 400px; /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œå±…ä¸­æ˜¾ç¤º */
            margin: 0 auto 15px auto; /* å±…ä¸­ */
            font-size: 0.9rem;
            text-align: center; /* æ•´ä½“å†…å®¹å±…ä¸­ */
        }
        
        .rank-item {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            gap: 30px; /* æ–‡å­—å’Œåˆ†æ•°ä¹‹é—´çš„é—´è· */
        }
        
        .rank-item span {
            text-align: center;
            flex: 0 0 auto; /* ä¸è‡ªåŠ¨ä¼¸ç¼©ï¼Œä¿æŒå†…å®¹å®½åº¦ */
        }
        
        .rank-item span:last-child {
            min-width: 60px; /* ç¡®ä¿åˆ†æ•°æœ‰è¶³å¤Ÿç©ºé—´ */
        }
        
        .rank-num { color: var(--accent-color); font-weight: bold; width: 25px;}

        /* Shake åŠ¨ç”» */
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-3px, 0, 0); }
            40%, 60% { transform: translate3d(3px, 0, 0); }
        }

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="72e984c31dea060cfa8da9baf7732030.jpg" alt="Offenbar Logo" class="logo-img">
        <div class="game-title">æ•å¼€å€’é…’å¤§æ¯”æ‹¼</div>
    </div>

    <!-- 1. å¼€å§‹é¡µé¢ -->
    <div id="screen-start" class="screen active">
        <div style="flex-grow:1; display:flex; flex-direction:column; justify-content:center; width:100%; align-items:center;">
            <p style="margin-bottom: 20px; color: #aaa; text-align: center; line-height: 1.6;">
                é•¿æŒ‰å€’é…’ï¼Œæ¾å¼€åœæ­¢ã€‚<br>è¿™æ˜¯å¯¹ä½ æ‰‹æ„Ÿçš„æè‡´è€ƒéªŒã€‚
            </p>
            <p style="margin-bottom: 25px; color: var(--accent-color); text-align: center; font-size: 0.95rem; font-weight: bold; text-shadow: 0 0 10px rgba(243, 156, 18, 0.5); line-height: 1.6;">
                12.14 - 12.16 æœŸé—´<br>
                å¹³å‡åˆ†è¶…è¿‡ 80<br>
                å…è´¹é€ä¸€æ¯ç²¾é…¿ shot å“¦ï¼
            </p>
            <input type="text" id="username" placeholder="è¯·è¾“å…¥ä½ çš„åå­—" maxlength="8">
            <button class="btn" onclick="startGame()">å¼€å§‹æŒ‘æˆ˜</button>
        </div>
        <div style="margin-bottom: 20px; font-size: 0.8rem; color: #555;">
            æœ€é«˜çºªå½•: <span id="top-player">-</span>
        </div>
    </div>

    <!-- 2. æ¸¸æˆä¸»é¡µé¢ -->
    <div id="screen-game" class="screen">
        <div class="game-info">
            <span style="margin-left: 10px;">æŒ‘æˆ˜è€…ï¼š<span id="game-user"></span></span>
            <span style="margin-right: 10px;">Round <span id="round-indicator">1/3</span></span>
        </div>

        <!-- è§†è§‰è¡¨ç°åŒºåŸŸï¼šç“¶å­ä¸æ°´æµ -->
        <div class="visual-area">
            <!-- æ‰€æœ‰çš„åŠ¨ä½œéƒ½åŸºäºè¿™ä¸ªç»å¯¹ä¸­å¿ƒç‚¹ -->
            <div class="pour-point">
                <div class="bottle-container" id="bottle">
                    <div class="bottle-body">
                        <div class="bottle-label">OFFENBAR</div>
                    </div>
                </div>
                <div class="stream" id="stream"></div>
            </div>
        </div>

        <!-- æ¥é…’åŒºåŸŸ -->
        <div class="glass-area">
            <div id="glass" class="glass beer">
                <div class="target-zone" id="target-zone">
                    <div class="target-label">PERFECT</div>
                </div>
                <div class="liquid" id="liquid">
                    <div class="foam"></div>
                </div>
            </div>
        </div>

        <!-- æ“æ§åŒºåŸŸ -->
        <div class="controls-area">
            <div class="instruction-text">æŒ‰ä½ä¸‹æ–¹æŒ‰é’®å€’é…’</div>
            <div class="pour-btn" id="pour-btn">
                é•¿æŒ‰å€’é…’
            </div>
        </div>
    </div>

    <!-- 3. ç»“ç®—é¡µé¢ -->
    <div id="screen-result" class="screen">
        <h2 id="result-title" style="margin: 10px 0; font-size: 1.5rem;">Result</h2>
        <div class="score-display" id="round-score">0</div>
        <div class="score-msg" id="score-msg">...</div>
        
        <div id="final-stats" class="leaderboard-container" style="display: none; width: 100%; flex-shrink: 0;">
            <div class="leaderboard-box">
                <div style="display:flex; justify-content:center; align-items:center; border-bottom:1px solid #444; padding-bottom:5px; margin-bottom:5px; color:#888; font-size:0.8rem; gap:30px;">
                    <span style="text-align:center;">ROUND</span><span style="text-align:center;">SCORE</span>
                </div>
                <div class="rank-item"><span>ç¬¬ä¸€æ¯</span><span id="score-r1">-</span></div>
                <div class="rank-item"><span>ç¬¬äºŒæ¯</span><span id="score-r2">-</span></div>
                <div class="rank-item"><span>ç¬¬ä¸‰æ¯</span><span id="score-r3">-</span></div>
                <div class="rank-item" style="margin-top: 5px; font-weight: bold; border-top: 1px solid #555; padding-top:10px;">
                    <span style="color:#fff;">æœ€ç»ˆå¹³å‡åˆ†</span><span id="score-avg" style="color:var(--accent-color); font-size:1.2rem;">-</span>
                </div>
            </div>

        </div>

        <!-- é…’é¦†åœ°å€å’Œæ¬¢è¿è¯­ -->
        <div id="bar-info" style="display:none; width:90%; max-width:400px; margin:15px auto; padding:15px; background:rgba(255,255,255,0.05); border-radius:10px; text-align:center;">
            <div style="font-size:0.85rem; color:#aaa; line-height:1.6; margin-bottom:10px;">
                ğŸª æ•å¼€é…’é¦†<br>
                <span style="font-size:0.75rem;">æ‹±å¢…åŒºä¹å ¤æ¸¯BåŒºè¿‘ä¸½æ°´è·¯å•å‘ç©ºé—´1æ¥¼</span>
            </div>
            <div id="welcome-msg" style="display:none; font-size:0.9rem; color:var(--accent-color); line-height:1.8; padding:10px; background:rgba(243,156,18,0.1); border-radius:8px; border:1px dashed var(--accent-color);">
                å¯ä»¥æˆªå›¾ä¿å­˜æ­¤é¡µé¢ï¼Œå‰å¾€æ•å¼€é…’é¦†å…‘æ¢ä¸€æ¯ç²¾é…¿ shot ğŸº
            </div>
            <div id="retry-msg" style="display:none; font-size:0.9rem; color:#aaa; line-height:1.8; padding:10px; background:rgba(255,255,255,0.05); border-radius:8px; border:1px dashed rgba(255,255,255,0.2);">
                å†è¯•ä¸€æ¬¡ï¼Œäº‰å–è¾¾åˆ°80åˆ†ä»¥ä¸Šå§ï¼ğŸ’ª
            </div>
        </div>

        <div style="flex-shrink: 0; padding: 20px 0 40px 0; text-align: center;">
            <button class="btn" id="next-btn" onclick="nextRound()">ä¸‹ä¸€æ¯</button>
            <button class="btn" id="restart-btn" onclick="resetGame()" style="display:none; background:var(--accent-color); color:#fff;">å†æ¥ä¸€å±€</button>
            <button class="btn" id="share-btn" onclick="guideToShare()" style="display:none; background:#fff; color:#000; margin-top:10px;">ğŸ“¤ å‘ç»™æœ‹å‹è¯•è¯•</button>
        </div>
    </div>
</div>

<script>
    const GameState = {
        user: '',
        round: 1,
        maxRounds: 3,
        scores: [],
        isPouring: false,
        liquidHeight: 0,
        fillSpeed: 0.8,
        glassType: 'beer',
        targetMin: 0,
        targetMax: 0,
        animationFrame: null
    };

    const ui = {
        screens: {
            start: document.getElementById('screen-start'),
            game: document.getElementById('screen-game'),
            result: document.getElementById('screen-result')
        },
        el: {
            username: document.getElementById('username'),
            gameUser: document.getElementById('game-user'),
            roundInd: document.getElementById('round-indicator'),
            glass: document.getElementById('glass'),
            liquid: document.getElementById('liquid'),
            targetZone: document.getElementById('target-zone'),
            pourBtn: document.getElementById('pour-btn'),
            bottle: document.getElementById('bottle'),
            stream: document.getElementById('stream'),
            resultTitle: document.getElementById('result-title'),
            roundScore: document.getElementById('round-score'),
            scoreMsg: document.getElementById('score-msg'),
            finalStats: document.getElementById('final-stats'),
            nextBtn: document.getElementById('next-btn'),
            restartBtn: document.getElementById('restart-btn'),
            leaderboardList: document.getElementById('leaderboard-list'),
            topPlayer: document.getElementById('top-player')
        }
    };

    function init() {
        loadLeaderboard();
        updateTopPlayerDisplay();
        
        const btn = ui.el.pourBtn;

        // ç»Ÿä¸€å¤„ç†å¼€å§‹å€’é…’
        const startAction = (e) => {
            // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼ˆå¦‚é¼ æ ‡é€‰æ‹©æˆ–è§¦æ‘¸æ»šåŠ¨ï¼‰
            if (e.cancelable) e.preventDefault();
            
            if(btn.classList.contains('disabled')) return;
            if (!GameState.isPouring) {
                GameState.isPouring = true;
                btn.style.transform = 'scale(0.9)'; // è§†è§‰åé¦ˆ
                ui.el.bottle.classList.add('pouring');
                
                // ç¨å¾®å»¶è¿Ÿå‡ºæ°´ï¼Œé…åˆç“¶å­æ—‹è½¬åŠ¨ç”»
                setTimeout(() => {
                    if(GameState.isPouring) {
                        ui.el.stream.classList.add('active'); // æ˜¾ç¤ºå›ºå®šé•¿åº¦çš„æ°´æµ
                        gameLoop();
                    }
                }, 100);
            }
        };

        // ç»Ÿä¸€å¤„ç†åœæ­¢å€’é…’
        const stopAction = (e) => {
            if (e.cancelable) e.preventDefault();
            
            if (GameState.isPouring) {
                GameState.isPouring = false;
                btn.style.transform = 'scale(1)';
                ui.el.bottle.classList.remove('pouring');
                ui.el.stream.classList.remove('active'); // éšè—æ°´æµ
                cancelAnimationFrame(GameState.animationFrame);
                calculateScore();
            }
        };

        // ç»‘å®šäº‹ä»¶ï¼Œæ¶µç›–ç§»åŠ¨ç«¯å’ŒPCç«¯
        btn.addEventListener('touchstart', startAction, {passive: false});
        btn.addEventListener('mousedown', startAction);

        btn.addEventListener('touchend', stopAction);
        btn.addEventListener('mouseup', stopAction);
        btn.addEventListener('mouseleave', stopAction);
        
        // é˜²æ­¢iOSåŒå‡»ç¼©æ”¾
        document.addEventListener('dblclick', function(event) {
            event.preventDefault();
        }, { passive: false });
    }

    function switchScreen(name) {
        Object.values(ui.screens).forEach(s => s.classList.remove('active'));
        ui.screens[name].classList.add('active');
        
        // æ§åˆ¶ç»“æœé¡µçš„æ ·å¼
        const container = document.querySelector('.container');
        if (name === 'result') {
            container.classList.add('result-page');
        } else {
            container.classList.remove('result-page');
        }
    }

    function startGame() {
        const name = ui.el.username.value.trim();
        if (!name) {
            // ä½¿ç”¨è‡ªå®šä¹‰æ ·å¼çš„æç¤ºï¼Œè€Œä¸æ˜¯alertï¼Œä½“éªŒæ›´å¥½
            ui.el.username.placeholder = "è¯·å…ˆè¾“å…¥åå­—!";
            ui.el.username.focus();
            return;
        }
        GameState.user = name;
        GameState.round = 1;
        GameState.scores = [];
        ui.el.gameUser.innerText = name;
        setupRound();
    }

    function setupRound() {
        GameState.liquidHeight = 0;
        GameState.isPouring = false;
        ui.el.liquid.style.height = '0%';
        ui.el.stream.classList.remove('active'); // éšè—æ°´æµ
        ui.el.pourBtn.classList.remove('disabled');
        ui.el.roundInd.innerText = `${GameState.round}/${GameState.maxRounds}`;
        
        // å›ºå®šä½¿ç”¨beeræ¯
        GameState.glassType = 'beer';
        ui.el.glass.className = `glass beer`;
        
        // å›ºå®šç›®æ ‡åŒºåŸŸä½ç½®
        const zoneSize = 12; 
        const targetBottom = 70; // å›ºå®šåœ¨70%çš„ä½ç½®
        
        GameState.targetMin = targetBottom;
        GameState.targetMax = targetBottom + zoneSize;
        
        ui.el.targetZone.style.bottom = `${targetBottom}%`;
        ui.el.targetZone.style.height = `${zoneSize}%`;
        ui.el.targetZone.style.borderColor = 'rgba(255,255,255,0.5)';

        switchScreen('game');
    }

    function gameLoop() {
        if (!GameState.isPouring) return;

        // éšç€æ—¶é—´æ¨ç§»é€Ÿåº¦å¾®å¢ï¼Œå¢åŠ ç´§å¼ æ„Ÿ
        let currentSpeed = GameState.fillSpeed;
        if (GameState.liquidHeight > 50) currentSpeed *= 1.1;
        if (GameState.liquidHeight > 80) currentSpeed *= 1.2;

        GameState.liquidHeight += currentSpeed;
        
        if (GameState.liquidHeight >= 100) {
            GameState.liquidHeight = 100;
            ui.el.liquid.style.height = '100%';
            // å¼ºåˆ¶åœæ­¢
            const event = new MouseEvent('mouseup');
            ui.el.pourBtn.dispatchEvent(event);
            // é¢å¤–è§¦å‘é€»è¾‘åœæ­¢ä»¥é˜²ä¸‡ä¸€
            if(GameState.isPouring) {
                 GameState.isPouring = false;
                 ui.el.bottle.classList.remove('pouring');
                 ui.el.stream.classList.remove('active');
                 calculateScore();
            }
        } else {
            ui.el.liquid.style.height = `${GameState.liquidHeight}%`;
            GameState.animationFrame = requestAnimationFrame(gameLoop);
        }
    }

    function calculateScore() {
        ui.el.pourBtn.classList.add('disabled');
        
        setTimeout(() => {
            const h = GameState.liquidHeight;
            const min = GameState.targetMin;
            const max = GameState.targetMax;
            const center = min + (max - min) / 2;
            
            let score = 0;
            let msg = "";
            let color = "#fff";

            if (h < min) {
                score = Math.max(0, Math.floor((h/min) * 30)); // ç»™ç‚¹åŒæƒ…åˆ†
                msg = "å¤ªå°‘äº†ï¼Œè¿™ä¸å¤Ÿå–ï¼";
                color = "var(--fail-color)";
            } else if (h > max) {
                 // æº¢å‡ºé€»è¾‘ï¼šåªè¦è¶…è¿‡çº¿å°±ç®—0åˆ†? 
                 // ä¸ºäº†æ¸¸æˆä½“éªŒï¼Œç¨å¾®è¶…è¿‡ä¸€ç‚¹ç‚¹æ‰£åˆ†ï¼Œè¶…è¿‡å¤ªå¤š0åˆ†
                 const over = h - max;
                 if (over > 5) {
                    score = 0;
                    msg = "æº¢å‡ºæ¥äº†ï¼å¤ªæµªè´¹äº†ï¼";
                    color = "var(--fail-color)";
                 } else {
                    score = 40;
                    msg = "ç¨å¾®æœ‰ç‚¹å¤šäº†...";
                    color = "#e67e22";
                 }
            } else {
                // åŒºé—´å†…
                const diff = Math.abs(h - center);
                const halfZone = (max - min) / 2;
                const percentage = 1 - (diff / halfZone); // 0 to 1
                score = 50 + Math.floor(percentage * 50); // 50-100åˆ†

                if (score >= 98) {
                    score = 100;
                    msg = "PERFECT POUR!";
                    color = "var(--success-color)";
                    ui.el.glass.classList.add('shake');
                } else if (score >= 85) {
                    msg = "Excellent!";
                    color = "#f1c40f";
                } else {
                    msg = "Good job.";
                    color = "#fff";
                }
            }

            GameState.scores.push(score);
            ui.el.targetZone.style.borderColor = color;
            
            setTimeout(() => {
                showResult(score, msg, color);
            }, 600);

        }, 400);
    }

    function showResult(score, msg, color) {
        ui.el.roundScore.innerText = score;
        ui.el.roundScore.style.color = color;
        ui.el.scoreMsg.innerText = msg;
        ui.el.scoreMsg.style.color = color === '#fff' ? '#aaa' : color;
        ui.el.resultTitle.innerText = `Round ${GameState.round}`;
        
        // å‰ä¸¤è½®éšè—final-statsï¼Œæœ€åä¸€è½®ä¼šåœ¨handleFinalResultä¸­æ˜¾ç¤º
        if (GameState.round < GameState.maxRounds) {
            ui.el.finalStats.style.display = 'none';
        }
        ui.el.nextBtn.style.display = 'inline-block';
        ui.el.restartBtn.style.display = 'none';

        if (GameState.round >= GameState.maxRounds) {
            handleFinalResult();
        } else {
            // å‰ä¸¤è½®ï¼šéšè—é…’é¦†ä¿¡æ¯å’Œåˆ†äº«æŒ‰é’®
            document.getElementById('bar-info').style.display = 'none';
            document.getElementById('share-btn').style.display = 'none';
            switchScreen('result');
        }
    }

    function handleFinalResult() {
        switchScreen('result');
        ui.el.resultTitle.innerText = "";
        ui.el.nextBtn.style.display = 'none';
        
        const total = GameState.scores.reduce((a, b) => a + b, 0);
        const avg = Math.round(total / GameState.maxRounds);
        
        ui.el.roundScore.innerText = avg;
        ui.el.roundScore.style.color = 'var(--accent-color)';
        ui.el.scoreMsg.innerText = "æœ€ç»ˆå¹³å‡å¾—åˆ†";
        
        document.getElementById('score-r1').innerText = GameState.scores[0];
        document.getElementById('score-r2').innerText = GameState.scores[1];
        document.getElementById('score-r3').innerText = GameState.scores[2];
        document.getElementById('score-avg').innerText = avg;
        
        ui.el.finalStats.style.display = 'flex';
        ui.el.finalStats.style.flexDirection = 'column';
        ui.el.restartBtn.style.display = 'inline-block';
        document.getElementById('share-btn').style.display = 'inline-block';
        
        // åªåœ¨æœ€åä¸€è½®æ˜¾ç¤ºé…’é¦†ä¿¡æ¯
        document.getElementById('bar-info').style.display = 'block';
        
        // å¦‚æœåˆ†æ•°>=80ï¼Œæ˜¾ç¤ºå…‘æ¢æç¤ºï¼›å¦åˆ™æ˜¾ç¤ºå†è¯•ä¸€æ¬¡æç¤º
        if (avg >= 80) {
            document.getElementById('welcome-msg').style.display = 'block';
            document.getElementById('retry-msg').style.display = 'none';
        } else {
            document.getElementById('welcome-msg').style.display = 'none';
            document.getElementById('retry-msg').style.display = 'block';
        }
        
        saveScore(GameState.user, avg);
    }

    function nextRound() {
        GameState.round++;
        setupRound();
    }

    function resetGame() {
        switchScreen('start');
        ui.el.glass.classList.remove('shake');
        ui.el.username.value = '';
        ui.el.username.placeholder = 'è¯·è¾“å…¥ä½ çš„åå­—';
    }

    function loadLeaderboard() {
        try {
            const data = localStorage.getItem('offenbar_scores_v2'); // v2 key
            return data ? JSON.parse(data) : [];
        } catch(e) { return []; }
    }

    function saveScore(name, score) {
        let list = loadLeaderboard();
        list.push({ name: name, score: score, date: Date.now() });
        list.sort((a, b) => b.score - a.score);
        list = list.slice(0, 10); // å¢åŠ åˆ°å‰10å
        localStorage.setItem('offenbar_scores_v2', JSON.stringify(list));
    }

    function guideToShare() {
        // æ˜¾ç¤ºæç¤ºï¼Œå¼•å¯¼ç”¨æˆ·ç‚¹å‡»å³ä¸Šè§’åˆ†äº«æŒ‰é’®
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            right: 0;
            width: 200px;
            height: 150px;
            background: rgba(243, 156, 18, 0.95);
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 0 0 0 20px;
            font-size: 1.2rem;
            font-weight: bold;
            z-index: 9999;
            animation: pulse 0.5s ease-in-out infinite alternate;
        `;
        overlay.innerHTML = `
            <div style="font-size:3rem; margin-bottom:10px;">â˜ï¸</div>
            <div>ç‚¹å‡»å³ä¸Šè§’</div>
            <div style="font-size:0.9rem; margin-top:5px;">åˆ†äº«ç»™æœ‹å‹</div>
        `;
        document.body.appendChild(overlay);
        
        // æ·»åŠ è„‰å†²åŠ¨ç”»
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                from { transform: scale(1); }
                to { transform: scale(1.05); }
            }
        `;
        document.head.appendChild(style);
        
        // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            overlay.style.transition = 'opacity 0.5s';
            overlay.style.opacity = '0';
            setTimeout(() => overlay.remove(), 500);
        }, 3000);
    }

    function updateTopPlayerDisplay() {
        const list = loadLeaderboard();
        if (list.length > 0) {
            ui.el.topPlayer.innerText = `${list[0].name} (${list[0].score})`;
        }
    }

    init();

</script>
</body>
</html>